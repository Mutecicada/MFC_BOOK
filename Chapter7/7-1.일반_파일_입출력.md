# 일반 파일 입출력

- **일반 파일 입출력** : CFile (파생)클래스 객체를 생성하고, Read()나 Write() 같은 멤버 함수를 이용해 파일 입출력을 처리한다.

- **직렬화** : CArchive 클래스 객체를 생성하고, << 또는 >> 연산자를 이용해 파일 입출력을 처리한다. 직렬화와 MFC의 도큐먼트/뷰 구조를 결합하면 파일 입출력을 좀더 편리하게 할 수 있다.

## CFile 클래스
- 파일을 열거나 생성한다(Open).
- 입출력 위치를 변경한다(Seek).
- 데이터를 읽고(Read) 쓴다(Write).
- 파일을 닫는다(Close).
-------------
<br>

## 열기와 생성
- CFile 클래스 생성자를 이용하면 파일을 열거나 생성할 수 있다. (리턴값이 없다)
```C++
try {
    CFile file(_T("mytest.txt"), CFile::modeReadWrite);
}
catch (CFileException *e) {
    e->ReportError();
    e->Delete();
}
```
- 생성자 대신 CFil::Open() 함수로 파일을 열거나 만들 수도 있다.

- 리턴값이 있어 일반 함수처럼 오류처리를 하면된다.
```C++
CFile file;
CFileExcetion e;
if(!file.Open(_T("mytest.txt"), CFile::modeReadWrite, &e))
    e.ReportError();
```

- CFile::CFile()와 CFile::Open() 함수의 첫 번째 인자는 `파일명`이고 두 번째 인자는 `접근과 공유 모드`를 나타내는 플래그 값이다. `|` 연산자로 여러 개의 플래그 값을 조합해 사용할 수 있다.

| <center> 플래그 </center> | <center> 의미 </center> |
|:--------:|:--------|
| CFile::modeCreate | 파일을 무조건 생성한다. 이름이 같은 파일이 있다면 크기를 0으로 바꾼다.
| CFile::modeNoTruncate | \| 연산자로 CFile::modeCreate 플래그와 조합해서 사용하면, 이름이 같은 파일이 있을 때 크기를 0으로 바꾸지 않고 그 파일을 연다. |
| CFile::modeRead | 파일을 읽기 전용모드로 열거나 생성한다. |
| CFile::modeReadWrite | 파일을 읽기 및 쓰기 모드로 열거나 생성한다. |
| CFile::modeWrite | 파일을 쓰기 전용 모드로 열거나 생성한다. |
| CFile::shareDenyNone | 파일에 대한 읽기와 쓰기를 다른 프로세스에 허용한다. |
| CFile::shareDenyRead | 다른 프로세스가 파일을 읽는 것을 금한다. |
| CFile::sharyDenyWrite | 다른 프로세스가 파일에 쓰는 것을 금한다. |
| CFile::shareExclusive | 다른 프로세스가 파일을 읽거나 파일에 쓰는 것을 금한다. |

<br>
<br>

## 닫기
- CFile 객체를 로컬 변수로 선언하여 파일을 열면 객체 소멸 시 자동으로 파일을 닫는다.

- CFile::Close() 함수를 사용해 명식적으로 파일을 닫을 수 있으며, 이 방법은 CFile객체 한 개를 이용해 여러 개의 파일을 다룰 때 유용하다.

<br><br>

## 읽기와 쓰기
- CFile:Read()와 CFile:Write() 함수는 파일의 특정 위치(파일 포인터)에서 데이터를 읽거나 쓴다. lpBuf는 버퍼의 시작 주소이고 nCount는 전송할 바이트 수다.

- Read() 함수의 리턴값은 파일에서 실제로 읽은 바이트 수로, 값이 nCount보다 작을 수 있다.
```C++
UINT CFile::Read(void* lpBuf, UINT nCount);
void CFile::Write(const void* lpBuf, UINT nCount);
```

### 입출력 위치 변경하기
- CFile::Seek() 함수는 파일 포인터를 임의 위치로 옮겨준다.

```C++
ULONGLONG CFile::Seek(LONGLONG lOff, UINT nFrom);
```

- lOff는 부호가 있는 정수값으로 양수/0/음수가 될 수 있는데, 이 크기만큼 파일 포인터를 이동한다.

- nFrom은 파일 포인터 이동 시 기준점을 나타내는 값이다.

- CFile::Seek() 함수의 리턴값은 부호 없는 정수값으로, 파일의 맨 앞을 기준으로 최정적인 파일 포인터의 위치를 나타낸다.

| <center> nFrom </center> | <center> 의미 </center> |
|:--------:|:--------|
| CFile::begin | 파일의 처음 위치에서 lOff만큼 파일 포인터를 이동한다. |
| CFile::current | 현재 파일 포인터 위치에서 lOff만큼 파일 포인터를 이동한다. |
| CFile::end | 파일의 끝 위치에서 lOff만큼 파일 포인터를 이동한다. |

##### ※ CFile::SeekToBegin(), SeekToEnd() 함수를 이용할 수 있다.

- 그외에 많이 사용하는 함수를 표로 정리하였다.

| <center> 함수 이름 </center> | <center> 의미 </center> |
|:--------:|:--------|
| CFile::GetLength() | 파일의 현재 크기를 얻는다. |
| CFile::SetLength() | 파일의 현재 크기를 변경한다. |
| CFile::GetPosition() | 파일 포인터의 현재 위치를 얻는다. |
| CFile::LockRange() | 파일의 일정 영역을 잠궈서 다른 프로세스가 접근할 수 없게 만든다. |
| CFile::UnlockRange() | 파일의 일정 영역의 잠금을 헤제한다. |
| CFile::GetFilePath() | 파일 전체 경로를 얻는다. |
| CFIle::GetFileName() | 파일의 이름을 얻는다. |

--------------------


## CMemFile
- 디스크가 아닌 메모리에 존재하는 파일을 생성할 수 있다.

- 메모리의 일부 영역을 파일처럼 다루는 방식이므로 임시로 사용하거나 빠르게 입출력할 수 있는 파일이 필요할 때 유용하다.

- 파일을 여는 과정 없이 객체를 만든 후 동일하게 입출력 함수를 사용하면 된다.
```C++
void CChildView::OnLButtonDown(UINT nFlags, CPoint point)
{
    CMemFile file;

    int a = 100;
    file.Write(&a, sizeof(a));

    file.SeekToBegin();
    int b;
    file.Read(&b, sizeof(b));

    TRACE(_T("b=%d\n"), b);
}
```


## CStdioFile
- 텍스트 파일을 줄 단위로 읽고 쓸 수 있는 CStdioFile::ReadString()과 CStdioFile::WriteString() 함수를 제공한다.

```C++
void CChildView::OnLButtonDown(UINT nFlags, CPoint point)
{
    CStdioFile file1;
    CFileException e;
    if(!file1.Open(_T("test1.txt"), CFile::modeRead, &e))
    {
        e.ReportError();
        return;
    }

    CStdioFile file2;
    if(!file2.Open(_T("test2.txt"), CFIle::modeWrite|CFile::modeCreate, &e))
    {
        e.ReportError();
        return;
    }

    CString str;
    while(file1.ReadString(str))
    {
        str.MakeUpper();
        file2.WriteString(str + '\n');
    }
}

```

- test1.txt 파일을 읽어서 모두 대문자로 바꾸어 test2.txt 파일에 저장하는 예시이다.

## CFileFind
- 파일 검색 기능을 제공한다. CFile 클래스와는 무관하고 인터넷 서비스 카테고리로 분류된다.

```C++
void CChildView::OnLButtonDown(UINT nFlags, CPoint point)
{
    CFileFind finder;
    BOOL bWorking = finder.FindFile(_T("*.*"));
    while(bWorking)
    {
        bWorking = finder.FindNextFile();
        if(finder.IsDirectory())
            Trace(_T("[%s]\n"), (LPCTSTR)finder.GetFileName());
        else
            Trace(_T("%s\n"), (LPCTSTR)finder.GetFileName());
        
    }
```
- 현재 디렉터리에 있는 모든 파일과 디렉터리를 보여주는 예제이다.

- 찾으려는 파일 이름을 CFileFind::FindFile() 함수에 문자열 형태로 넘겨준다.

- 함수의 리턴값이 TRUE라면 조건을 만족하는 파일이 한개 이상있다는 뜻이다.

- FALSE까지 CFileFind::FindNextFile() 함수를 호출하면 찾을 수 있다.

