# 트레이 아이콘과 팝업 메뉴
- 작업 표시줄 오른쪽에 작은 아이콘이 있는 곳을 `상태 영역(Staus Area)`이라 한다.

- 상태 영역에 있는 아이콘이 트레이 아이콘이다.

- 트레이 아이콘은 응용 프로그램 하나를 대표하면서 차지하는 공간이 적어서 조작 메뉴를 제공하는 것이 기본이다.

- `::Shell_NotifyIcon()` API 함수를 사용한다.
    - 첫 번째 인자에 NIM_ADD(MODIFY, DELETE)를 사용하여 추가, 수정, 삭제할 수 있다.
    - 두 번째 인자의 NOTIFYICONDATA 구조체를 통해 정보를 전달한다.

```C++
NOTIFYICONDATA nid;
ZeroMemory(&nid, sizeof(nid));      // 구조체 선언
nid.chSize = sizeof(nid);           
nid.UID = 0;                        // 구분할 수 있는 ID 값
nid.hWnd = GetSafeHwnd();           // 트레이를 소유한 윈도우 핸들

nid.uFlags = NIF_ICON | NIF_TIP | NIF_MESSAGE;
nid.hIcon = AfxGetApp()->LoadIcon(IDR_MAINFRAME);
lstrcpy(nid.szTip, _T("내 트레이"));
nid.uCallbackMessage = WM_TRAY_NOTIFICATION;

BOOL bRet = ::Shell_NotifyIcon(NIM_ADD, &nid);
```
- uFlags 멤버를 통해 `아이콘, 툴팁, 메시지` 사용 등을 지정한다.

- uCallbackMessage()는 트레이 아이콘에서 보내는 메시지를 구분할 수 있는 `사용자 메시지`를 정의하여 입력한다.

```C++
NOTIFYICONDATA nid;
ZeroMemory(&nid, sizeof(nid));
nid.cbSize = sizeof(nid);
nid.uID = 0;
nid.hWnd = GetSafeHwnd();
BOOL bRet = ::Shell_NotifyIcon(NIM_DELETE, &nid);
```
- 프로그램이 종료해도 트레이 아이콘이 사라지지 않고 마우스 커서를 올리면 사라지는데 OnDestroy() 함수에 다음과 같이 트레이 아이콘 제거 루틴을 넣는다.

- 제거할 때는 uID와 hWnd 멤버를 통해 ID와 윈도우 핸들값만 넘겨주면 된다.
- 트레이 아이콘에 팝업 메뉴가 나타나게 하려면, 등록할 때 uCallbackMessage 멤버에 넣었던 사용자 메시지를 처리하면 된다.


```C++
ON_MESSAGE(WM_TRAY_NOTIFICATION, OnTrayNotification)        // 메시지 맵
LRESULT CChildView::OnTrayNotification(WPARAM wParam, LPARAM lParam)
{
    switch(lParam)
    {
        case WM_RBUTTONDOWN:
        {
            CPoint ptMouse;
            ::GetCursorPos(&ptMouse);

            CMenu menu;
            menu.LoadMenu(IDR_MAINFRAME);
            pMenu->TrackPopupMenu(
                TPM_LEFTALIGN | TPM_RIGHTBUTTON,
                ptMouse.x, ptMouse.y, AfxGetMainWnd());
        }
        break;
    }
    return 1;
}
```